# app/routes/vulnerability_scan_routes.py
from flask import Blueprint, request, jsonify
import os
from app.utils.helpers import allowed_file, scan_vulnerabilities

# Create the Blueprint instance
vulnerability_scan_routes = Blueprint('vulnerability_scan_routes', __name__)

@vulnerability_scan_routes.route('/scan_vulnerability', methods=['POST'])
def scan_vulnerability():
    """
    Handle the vulnerability scan request. It receives the uploaded file,
    validates it, saves it temporarily, and runs the mock vulnerability scan.
    Returns scan results (vulnerabilities and risk levels).
    """
    if 'file' not in request.files:
        return jsonify({"error": "No file part"}), 400

    file = request.files['file']

    if file.filename == '':
        return jsonify({"error": "No selected file"}), 400

    if file and allowed_file(file.filename):
        # Save the file to a temporary location
        filename = os.path.join('uploads', file.filename)
        try:
            file.save(filename)
            # Debug: Ensure file is saved correctly
            print(f"File saved: {filename}")

            # Perform vulnerability scan
            vulnerabilities, risk_level = scan_vulnerabilities(filename)

            # Return the scan results to the frontend
            return jsonify({
                "vulnerabilities": vulnerabilities,
                "risk_level": risk_level
            })
        
        except Exception as e:
            return jsonify({"error": f"Error saving file: {str(e)}"}), 500

    return jsonify({"error": "Invalid file type"}), 400
